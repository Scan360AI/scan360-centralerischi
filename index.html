<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Centrale Rischi - Alpha Srl | SCAN</title>
    <!-- Librerie Esterne -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="../css/print.css" rel="stylesheet" media="print"> <!-- Adjusted path -->

    <!-- Stili Incorporati -->
    <style>
        /* Stili CSS (copiati e adattati) */
        .actions-card ol.action-list { padding-left: 0; list-style: none; }
        .actions-card li { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #eee;}
        .actions-card li:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .actions-card li strong { color: var(--primary); display: block; margin-bottom: 0.2rem;}
        .actions-card .priority-badge { font-size: 0.75rem; padding: 3px 8px; flex-shrink: 0; margin-left: 1rem;}

        /* Stili CR Score SECTION */
        .cr-score-section { background: linear-gradient(135deg, var(--white) 0%, #f0f4f8 100%); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 2.5rem; border: 1px solid var(--card-border); }
        /* Stili per il cerchio IRP/CR Score */
        .irp-score-circle { width: 140px; height: 140px; border-radius: 50%; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 0.5rem auto; box-shadow: 0 8px 20px rgba(0,0,0,0.25); border: 6px solid rgba(255, 255, 255, 0.5); }
        /* Colori per il cerchio basati sul rischio CR */
        .irp-score-circle.risk-low { background: radial-gradient(circle, #6bc571, #4CAF50); } /* >80 Ottimizzabile/Corretto */
        .irp-score-circle.risk-medium { background: radial-gradient(circle, #ffd54f, #FFC107); } /* 60-79 Monitoraggio */
        .irp-score-circle.risk-high { background: radial-gradient(circle, #f6685e, #F44336); } /* <60 Pericolo */
        .irp-score-value { font-size: 3.5rem; font-weight: 700; line-height: 1; text-shadow: 1px 1px 3px rgba(0,0,0,0.4);}
        .irp-score-max { font-size: 0.9rem; opacity: 0.8; display: block; line-height: 1;}
        .irp-category-text { font-size: 1.2rem; font-weight: 600; margin-top: 0.5rem; text-align: center; }
        .irp-category-text .status-badge { font-size: 0.85rem; vertical-align: middle; margin-left: 8px;}


        :root {
            --primary: #191970; --secondary: #4a69bd; --success: #4CAF50;
            --warning: #FFC107; --danger: #F44336; --info: #0dcaf0;
            --light: #f8f9fa; --dark: #343a40; --white: #ffffff;
            --text-primary: #212529; --text-secondary: #6c757d;
            --card-bg: var(--white); --card-border: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        html, body { height: 100%; overflow-x: hidden; font-family: 'Titillium Web', sans-serif; background-color: #f4f8fb; }
        body { display: flex; }
        .sidebar { width: 250px; background-color: var(--primary); color: #e0e0e0; position: fixed; top: 0; bottom: 0; left: 0; z-index: 1031; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1); transition: width 0.3s ease; overflow-y: auto; }
        .main-wrapper { margin-left: 250px; width: calc(100% - 250px); display: flex; flex-direction: column; min-height: 100vh; position: relative; padding-top: 70px; }
        .dashboard-header { background-color: var(--white); padding: 15px 30px; border-bottom: 1px solid var(--card-border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-height: 70px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 250px; right: 0; z-index: 1030; }
        .dashboard-container { padding: 30px; flex-grow: 1; width: 100%; }
        .footer { background-color: var(--primary); color: rgba(255, 255, 255, 0.7); padding: 15px 30px; font-size: 0.85rem; margin-top: auto; flex-shrink: 0; width: 100%; }
        .footer img { max-height: 20px; width: auto; filter: brightness(0) invert(1); opacity: 0.8; vertical-align: middle;}
        .sidebar-header { padding: 10px 20px; margin-bottom: 20px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-header img { max-height: 40px; } .sidebar-header h5 { color: var(--white); margin-top: 10px; font-size: 1.1rem; font-weight: 600; }
        .sidebar-nav { list-style: none; padding: 0; } .sidebar-nav .nav-item { margin: 0; }
        .sidebar-nav .nav-link { color: #e0e0e0; padding: 12px 20px; display: flex; align-items: center; font-size: 0.95rem; font-weight: 500; border-left: 4px solid transparent; transition: all 0.2s ease; }
        .sidebar-nav .nav-link:hover { background-color: rgba(255, 255, 255, 0.05); color: var(--white); border-left-color: var(--warning); }
        .sidebar-nav .nav-link.active { background-color: rgba(255, 255, 255, 0.1); color: var(--white); font-weight: 600; border-left-color: var(--white); }
        .sidebar-nav .nav-link i { margin-right: 15px; width: 20px; text-align: center; font-size: 1rem; }
        .sidebar-nav .nav-title { padding: 10px 20px; font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 15px; }
        .sidebar-footer { margin-top: auto; padding: 15px 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.9rem; text-align: left; }
        .section-title { color: var(--primary); font-weight: 600; margin-top: 2.5rem; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--secondary); font-size: 1.75rem; display: flex; align-items: center; } .section-title i { margin-right: 10px; }
        .section-title.small { font-size: 1.25rem; margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; }
        .dashboard-card { background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); transition: all 0.3s ease; height: 100%; }
        .dashboard-card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.1); transform: translateY(-3px); }
        .card-title-small { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .table { border: 1px solid var(--card-border); margin-bottom: 1rem; } .table thead th { background-color: var(--light); color: var(--primary); font-weight: 600; border-bottom: 2px solid var(--primary); font-size: 0.9rem; white-space: nowrap; } .table-hover tbody tr:hover { background-color: #eef2f7; } .table td, .table th { vertical-align: middle; padding: 0.6rem 0.75rem; font-size: 0.9rem;} .value-highlight { font-weight: 600; color: var(--primary); } .text-end { text-align: right !important;} .text-success { color: var(--success) !important; } .text-danger { color: var(--danger) !important; } .text-warning { color: var(--warning) !important; } .text-secondary { color: var(--text-secondary) !important; }
        .alert-box { padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid; } .alert-box h5 { margin-bottom: 10px; font-size: 1.1rem; font-weight: 600;} .alert-box ul { padding-left: 20px; margin-bottom: 0; font-size: 0.9rem;} .alert-box.alert-success { background-color: #d1e7dd; border-color: #a3cfbb; color: #0a3622; } .alert-box.alert-warning { background-color: #fff3cd; border-color: #ffda6a; color: #664d03; } .alert-box.alert-danger { background-color: #f8d7da; border-color: #f1aeb5; color: #58151c; } .alert-box.alert-info { background-color: #cff4fc; border-color: #9eeaf9; color: #055160; }
        .status-badge { font-size: .75em; font-weight: 700; line-height: 1; padding: .35em .65em; border-radius: .375rem; color: white; display: inline-block; } .status-badge.bg-success { background-color: var(--success) !important; } .status-badge.bg-warning { background-color: var(--warning) !important; color: var(--dark) !important;} .status-badge.bg-danger { background-color: var(--danger) !important; } .status-badge.bg-info { background-color: var(--info) !important; color: var(--dark) !important;}
        .chart-container-cda { height: 350px; margin-bottom: 20px; background-color: var(--white); padding: 15px; border-radius: 8px; border: 1px solid var(--card-border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .icon-circle { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; color: white; margin-right: 12px; font-size: 0.9rem; flex-shrink: 0; }
        .bg-icon-success { background-color: var(--success); } .bg-icon-warning { background-color: var(--warning); } .bg-icon-danger { background-color: var(--danger); } .bg-icon-info { background-color: #4f6d7a; } .bg-icon-primary { background-color: var(--primary); } .bg-icon-secondary { background-color: var(--secondary); }
        .kpi-card-v4 { display: flex; align-items: center; padding: 1rem; background-color: var(--white); border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 1.5rem; border: 1px solid var(--card-border); height: 100%;} .kpi-card-v4 .kpi-content { margin-left: 0; flex-grow: 1;} .kpi-card-v4 .kpi-header { display: flex; align-items: center; margin-bottom: 5px;} .kpi-card-v4 .kpi-title { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0; line-height: 1.2;} .kpi-card-v4 .kpi-value { font-size: 1.7rem; font-weight: 700; color: var(--dark); line-height: 1.2; margin-bottom: 3px;} .kpi-card-v4 .kpi-trend { font-size: 0.8rem; font-weight: 600; margin-top: 0px;} .kpi-card-v4 .kpi-trend .fas { margin-right: 4px; } .kpi-card-v4 .trend-up { color: var(--success); } .kpi-card-v4 .trend-down { color: var(--danger); } .kpi-card-v4 .trend-neutral { color: var(--text-secondary); }
        .accordion-item { background-color: var(--white); border: 1px solid var(--card-border); border-radius: 8px !important; margin-bottom: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05);} .accordion-header { }
        .accordion-button { font-weight: 600; font-size: 1.1rem; color: var(--primary); background-color: #f8f9fa; box-shadow: none !important; border-radius: 7px 7px 0 0 !important;}
        .accordion-button:not(.collapsed) { color: var(--white); background-color: var(--secondary); }
        .accordion-button:focus { box-shadow: none; }
        .accordion-button::after { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23191970'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e"); transition: transform .2s ease-in-out;}
        .accordion-button:not(.collapsed)::after { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e"); transform: rotate(-180deg); }
        .accordion-body { padding: 1.5rem; font-size: 0.9rem; } .accordion-body h6 { font-weight: 600; color: var(--secondary); margin-top: 1rem; margin-bottom: 0.5rem; } .accordion-body .table { margin-top: 1rem; }
        .alert-card { display: flex; align-items: flex-start; padding: 1rem; border-radius: 8px; border: 1px solid; background-color: #f8f9fa; margin-bottom: 1rem; box-shadow: var(--shadow); }
        .alert-card .alert-icon { font-size: 1.8rem; margin-right: 1rem; flex-shrink: 0; width: 40px; text-align: center; }
        .alert-card h5 { font-weight: 600; margin-bottom: 0.3rem; font-size: 1.1rem; }
        .alert-card p { font-size: 0.9rem; margin-bottom: 0; line-height: 1.5; }
        .alert-card.alert-danger { border-color: #f1aeb5; color: #58151c; background-color: #f8d7da; } .alert-card.alert-danger .alert-icon { color: #a94442; }
        .alert-card.alert-warning { border-color: #ffda6a; color: #664d03; background-color: #fff3cd; } .alert-card.alert-warning .alert-icon { color: #8a6d3b; }
        .alert-card.alert-info { border-color: #9eeaf9; color: #055160; background-color: #cff4fc; } .alert-card.alert-info .alert-icon { color: #31708f; }
        .alert-card.alert-success { border-color: #a3cfbb; color: #0a3622; background-color: #d1e7dd; } .alert-card.alert-success .alert-icon { color: #3c763d; }
        .executive-summary-card { background-color: #f0f4f8; border-left: 5px solid var(--primary); border-radius: 8px; box-shadow: var(--shadow); }
        .executive-summary-card .card-body { padding: 1.5rem; }
        .card-title-modern { font-size: 1rem; font-weight: 600; color: var(--primary); margin-bottom: 1rem; text-align: center; }
        .chart-card { padding-top: 1rem; }

        @media (max-width: 991.98px) { .sidebar { width: 0; border: none; box-shadow: none;} .main-wrapper { margin-left: 0; width: 100%; padding-top: 56px; } .dashboard-header { left: 0; width: 100%; min-height: 56px; padding: 5px 15px;} .header-title h5 { font-size: 1rem;} .header-title p { font-size: 0.75rem;} .dashboard-container { padding: 15px;} .footer { padding: 10px 15px;} }
        @media print { body { display: block; } .main-wrapper { margin-left: 0; width: 100%; padding-top: 0; } .no-print { display: none !important; } .report-section { page-break-inside: avoid; } }

         /* Placeholder styles */
         .skeleton .placeholder { background-color: #e9ecef; }
    </style>
</head>
<body>

<!-- Sidebar -->
    <aside class="sidebar no-print">
         <div class="sidebar-header">
            <img src="assets/img/logo_scan.png" alt="SCAN Logo" style="max-height: 40px;"> <!-- Adjusted Path -->
            <h5 id="sidebarCompanyName">--</h5> <!-- Populated by JS -->
        </div>
        <ul class="sidebar-nav flex-grow-1">
            <!-- !! IMPORTANT: Keep original links !! -->
            
             <!-- !! Link interni alla pagina CR !! -->
             <li class="nav-item"> <a class="nav-link active" href="#cr-main-title"> <i class="fas fa-landmark fa-fw"></i> Analisi CR </a> </li>
             <li class="nav-item"> <a class="nav-link" href="#cr-summary-section"> <i class="fas fa-clipboard-check fa-fw"></i> Sintesi CR </a> </li>
             <li class="nav-item"> <a class="nav-link" href="#kpi-section"> <i class="fas fa-key fa-fw"></i> Indicatori CR </a> </li>
             <li class="nav-item"> <a class="nav-link" href="#alerts-section"> <i class="fas fa-bell fa-fw"></i> Anomalie Rilevate </a> </li>
             <li class="nav-item"> <a class="nav-link" href="#charts-section"> <i class="fas fa-chart-pie fa-fw"></i> Grafici CR </a> </li>
             <li class="nav-item"> <a class="nav-link" href="#details-accordion"> <i class="fas fa-layer-group fa-fw"></i> Dettaglio Aree </a> </li>
              <!-- !! Link alla home !! -->
<br>
<br>
             <li class="nav-item"> <a class="nav-link" href="index.html"> <i class="fas fa-home fa-fw"></i> Torna alla Home </a> </li>
<li class="nav-item"> <a class="nav-link" href="dashboard_v2.html"> <i class="fas fa-tachometer-alt fa-fw"></i> Dashboard Analisi</a> </li>
             
        </ul>
        <div class="sidebar-footer"> <small>SCAN360 © <span id="currentYearSidebar"></span> Kitzanos</small> </div>
    </aside>


    <!-- Contenuto Principale Wrapper -->
    <div class="main-wrapper">
        <!-- Header Orizzontale -->
        <header class="dashboard-header no-print">
            <div class="header-title">
                <h5 class="mb-0">Report Centrale Rischi</h5>
                <p class="mb-0"><span id="headerCompanyName">--</span> | <span class="report-date" id="headerReportDate">--</span></p>
            </div>
          
        </header>
        <div class="container d-none d-print-block mt-4 mb-4">
            <h1 class="text-center mb-0"><span class="company-name" id="printCompanyName">--</span></h1>
            <p class="text-center mb-0">Report Centrale Rischi | <span class="report-date" id="printReportDate">--</span></p>
            <hr>
        </div>

        <!-- Area Contenuto Specifico del Report CR -->
        <div class="dashboard-container">

             <h2 class="section-title" id="cr-main-title"><i class="fas fa-landmark me-2"></i>Analisi Centrale Rischi</h2>

             <!-- Executive Summary Card -->
            <div class="card executive-summary-card mb-4 report-section">
                 <div class="card-body">
                     <div class="row align-items-center">
                         <div class="col-lg-8">
                             <h4 class="card-title mb-3" style="color: var(--primary);"><i class="fas fa-info-circle me-2"></i>Sintesi Esecutiva CR (<span id="summaryReportDate">--</span>)</h4>
                             <!-- Populated by JS -->
                             <p class="mb-2" id="summaryText1">Caricamento sintesi...</p>
                             <p class="mb-0 text-danger" id="summaryText2"></p>
                         </div>
                         <!-- CR Score Visual Section (IRP Style Circle) -->
                         <div class="col-lg-4 text-center mt-3 mt-lg-0 cr-score-section" id="cr-summary-section">
                              <h6 class="card-title-small mb-1">Punteggio Centrale Rischi</h6>
                              <!-- Cerchio stile IRP -->
                               <div class="irp-score-circle" id="crScoreCircle"> <!-- ID aggiunto -->
                                  <span class="irp-score-value" id="crScoreCircleValue">--</span>
                                  <span class="irp-score-max">/ 100</span>
                              </div>
                              <!-- Testo sotto il cerchio -->
                              <div class="irp-category-text" id="crScoreCategoryText">
                                  -- <span class="status-badge" id="crScoreCategoryBadge">--</span>
                              </div>
                         </div>
                     </div>
                 </div>
             </div>

             <!-- Sezione KPI Principali CR -->
             <section id="kpi-section" class="report-section">
                  <h4 class="section-title small"><i class="fas fa-key me-2"></i>INDICATORI CHIAVE CR (<span id="kpiReportDate">--</span>)</h4>
                   <div class="row gy-4" id="kpi-cards-container">
                      <!-- KPI cards will be populated by JS -->
                      <div class="col-lg-3 col-md-6"><div class="kpi-card-v4 skeleton"> <span class="icon-circle bg-secondary"><i class="fas fa-spinner fa-spin"></i></span> <div class="kpi-content"> <div class="kpi-title placeholder-glow"><span class="placeholder col-8"></span></div> <div class="kpi-value placeholder-glow"><span class="placeholder col-5"></span></div> <div class="kpi-trend placeholder-glow"><span class="placeholder col-7"></span></div> </div> </div> </div>
                      <div class="col-lg-3 col-md-6"><div class="kpi-card-v4 skeleton"> <span class="icon-circle bg-secondary"><i class="fas fa-spinner fa-spin"></i></span> <div class="kpi-content"> <div class="kpi-title placeholder-glow"><span class="placeholder col-8"></span></div> <div class="kpi-value placeholder-glow"><span class="placeholder col-5"></span></div> <div class="kpi-trend placeholder-glow"><span class="placeholder col-7"></span></div> </div> </div> </div>
                      <div class="col-lg-3 col-md-6"><div class="kpi-card-v4 skeleton"> <span class="icon-circle bg-secondary"><i class="fas fa-spinner fa-spin"></i></span> <div class="kpi-content"> <div class="kpi-title placeholder-glow"><span class="placeholder col-8"></span></div> <div class="kpi-value placeholder-glow"><span class="placeholder col-5"></span></div> <div class="kpi-trend placeholder-glow"><span class="placeholder col-7"></span></div> </div> </div> </div>
                      <div class="col-lg-3 col-md-6"><div class="kpi-card-v4 skeleton"> <span class="icon-circle bg-secondary"><i class="fas fa-spinner fa-spin"></i></span> <div class="kpi-content"> <div class="kpi-title placeholder-glow"><span class="placeholder col-8"></span></div> <div class="kpi-value placeholder-glow"><span class="placeholder col-5"></span></div> <div class="kpi-trend placeholder-glow"><span class="placeholder col-7"></span></div> </div> </div> </div>
                   </div>
             </section>

             <!-- Sezione Alert Principali CR -->
             <section id="alerts-section" class="report-section">
                 <h4 class="section-title small"><i class="fas fa-bell me-2 text-danger"></i>ANOMALIE CR RILEVATE (<span id="alertsReportDate">--</span>)</h4>
                 <div class="row" id="alerts-container">
                     <!-- Alert cards will be populated by JS -->
                     <div class="col-12"><p class="text-muted">Caricamento anomalie...</p></div>
                 </div>
             </section>

             <!-- Sezione Grafici Chiave CR -->
             <section id="charts-section" class="report-section">
                   <h4 class="section-title small"><i class="fas fa-chart-pie me-2"></i>GRAFICI CHIAVE CR</h4>
                   <div class="row">
                       <div class="col-lg-6 mb-4">
                            <div class="dashboard-card chart-card">
                                <h6 class="card-title-modern">Andamento Accordato/Utilizzato Totale (12 mesi)</h6>
                                <div class="chart-container-cda" style="height: 350px;">
                                     <canvas id="trendAccordiUtilizziChart"></canvas>
                                 </div>
                            </div>
                       </div>
                       <div class="col-lg-6 mb-4">
                            <div class="dashboard-card chart-card">
                                <h6 class="card-title-modern">Distribuzione Affidamenti per Tipo (Ult. Mese)</h6>
                                <div class="chart-container-cda" style="height: 350px;">
                                      <canvas id="distAffidamentiChart"></canvas>
                                 </div>
                            </div>
                       </div>
                        <div class="col-lg-6 mb-4">
                           <div class="dashboard-card chart-card">
                               <h6 class="card-title-modern">Andamento Segnalazioni Negative (Ultimi 6 mesi)</h6>
                               <div class="chart-container-cda" style="height: 350px;">
                                    <canvas id="trendSconfiniChart"></canvas>
                               </div>
                           </div>
                      </div>
                       <div class="col-lg-6 mb-4">
                            <div class="dashboard-card chart-card">
                                <h6 class="card-title-modern">Andamento Garanzie Ricevute (12 mesi)</h6>
                                <div class="chart-container-cda" style="height: 350px;">
                                     <canvas id="trendGaranzieChart"></canvas>
                                 </div>
                            </div>
                       </div>
                   </div>
              </section>

             <!-- SEZIONI DI DETTAGLIO CON ACCORDION -->
             <h2 class="section-title mt-5" id="details-accordion"><i class="fas fa-layer-group me-2"></i>Approfondimenti Dettagliati CR</h2>
             <div class="accordion report-section" id="crDetailsAccordion">

                 <!-- 1. Dettaglio Scoring e Anomalie -->
                 <div class="accordion-item">
                     <h2 class="accordion-header" id="headingScoring"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseScoring" aria-expanded="false" aria-controls="collapseScoring"> <i class="fas fa-star-half-alt me-2"></i> Scoring e Anomalie Rilevate </button> </h2>
                     <div id="collapseScoring" class="accordion-collapse collapse" aria-labelledby="headingScoring" data-bs-parent="#crDetailsAccordion">
                         <div class="accordion-body">
                              <h6>Punteggio CR (<span id="scoringReportDate1">--</span>): <span id="scoringValue1">--</span>/100 - <span id="scoringFascia1">--</span></h6>
                              <p id="scoringDesc1">Caricamento descrizione...</p>
                              <h6>Dettaglio Anomalie Presenti/Assenti</h6>
                              <ul class="list-group list-group-flush small" id="anomalie-list-details">
                                <li class="list-group-item placeholder-glow"><span class="placeholder col-10"></span></li>
                              </ul>
                         </div>
                     </div>
                 </div>

                 <!-- 2. Analisi Affidamenti e Utilizzi -->
                  <div class="accordion-item">
                      <h2 class="accordion-header" id="headingAffidamenti"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAffidamenti" aria-expanded="false" aria-controls="collapseAffidamenti"> <i class="fas fa-credit-card me-2"></i> Affidamenti e Utilizzi </button> </h2>
                      <div id="collapseAffidamenti" class="accordion-collapse collapse" aria-labelledby="headingAffidamenti" data-bs-parent="#crDetailsAccordion">
                          <div class="accordion-body">
                               <h6>Monte Affidamenti e Utilizzi (<span id="affidamentiReportDate">--</span>)</h6>
                               <div class="table-responsive mb-3">
                                   <table class="table table-sm table-striped" id="affidamentiTable">
                                       <thead><tr><th>Tipo</th><th class="text-end">Accordato (€)</th><th class="text-end">Utilizzato (€)</th><th class="text-end">Utilizzo %</th><th>Trend</th></tr></thead>
                                       <tbody><tr><td colspan="5" class="text-muted">Caricamento...</td></tr></tbody>
                                   </table>
                               </div>
                               <h6>Utilizzo Medio Linee (12 mesi)</h6>
                               <ul class="small" id="utilizzoMedioList">
                                   <li id="utilizzoMedioAutoliq">Autoliquidante: --%</li>
                                   <li id="utilizzoMedioScadenza">Scadenza: --%</li>
                                   <li id="utilizzoMedioRevoca">Revoca: --%</li>
                               </ul>
                               <p id="affidamentiDesc">Caricamento descrizione...</p>
                          </div>
                      </div>
                  </div>

                 <!-- 3. Analisi Sconfini e Impagati -->
                  <div class="accordion-item">
                      <h2 class="accordion-header" id="headingSconfini"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSconfini" aria-expanded="false" aria-controls="collapseSconfini"> <i class="fas fa-exclamation-triangle me-2"></i> Sconfini e Impagati </button> </h2>
                      <div id="collapseSconfini" class="accordion-collapse collapse" aria-labelledby="headingSconfini" data-bs-parent="#crDetailsAccordion">
                          <div class="accordion-body">
                              <h6>Sconfini / Impagati Segnalati (<span id="sconfiniReportDate">--</span>)</h6>
                              <p>Valore totale segnalato: <strong id="sconfiniTotali">--</strong>.</p>
                              <p>Tipo: <strong id="sconfiniTipo">--</strong></p>
                              <p>Evitabili: <strong id="sconfiniEvitabili">--</strong></p>
                              <p>Periodo Principale: <strong id="sconfiniPeriodo">--</strong></p>
                              <p id="sconfiniDesc">Caricamento descrizione...</p>
                              <h6>Banche con Segnalazioni Principali</h6>
                              <ul class="small" id="sconfiniBancheList">
                                  <li class="text-muted">Caricamento...</li>
                              </ul>
                          </div>
                      </div>
                   </div>

                  <!-- 4. Garanzie -->
                  <div class="accordion-item">
                      <h2 class="accordion-header" id="headingGaranzie"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGaranzie" aria-expanded="false" aria-controls="collapseGaranzie"> <i class="fas fa-shield-alt me-2"></i> Garanzie </button> </h2>
                      <div id="collapseGaranzie" class="accordion-collapse collapse" aria-labelledby="headingGaranzie" data-bs-parent="#crDetailsAccordion">
                          <div class="accordion-body">
                              <h6>Garanzie Ricevute (<span id="garanzieReportDate">--</span>)</h6>
                              <p>Totale garanzie ricevute: <strong id="garanzieTotali">--</strong>.</p>
                              <h6>Principali Garanti:</h6>
                              <ul class="small" id="garanzieList">
                                <li class="text-muted">Caricamento...</li>
                              </ul>
                              <p id="garanzieDesc">Caricamento descrizione...</p>
                          </div>
                      </div>
                  </div>

                  <!-- 5. Analisi Tesoreria (Sintesi) -->
                  <div class="accordion-item">
                       <h2 class="accordion-header" id="headingTesoreria"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTesoreria" aria-expanded="false" aria-controls="collapseTesoreria"> <i class="fas fa-cash-register me-2"></i> Sintesi Analisi Tesoreria </button> </h2>
                       <div id="collapseTesoreria" class="accordion-collapse collapse" aria-labelledby="headingTesoreria" data-bs-parent="#crDetailsAccordion">
                           <div class="accordion-body">
                               <h6 id="tesoreriaDispTitle">Disponibilità Media Fidi a Revoca (12 mesi)</h6>
                               <p id="tesoreriaDispDesc">Caricamento...</p>
                               <ul class="small" id="tesoreriaDispBanche">
                                   <li class="text-muted">Caricamento...</li>
                               </ul>
                               <h6 id="tesoreriaEqTitle" class="mt-3">Equilibrio Utilizzo Linee (12 mesi)</h6>
                               <ul class="small" id="tesoreriaEqList">
                                   <li>Autoliquidante: --%</li>
                                   <li>Scadenza: --%</li>
                                   <li>Revoca: --%</li>
                               </ul>
                               <p id="tesoreriaEqValutazione">Caricamento...</p>
                               <h6 id="tesoreriaRischioTitle" class="mt-3">Rischiosità Portafoglio / Impagati</h6>
                               <p id="tesoreriaRischioDesc">Caricamento...</p>
                           </div>
                       </div>
                  </div>

                 <!-- 6. Distinta Banche -->
                 <div class="accordion-item">
                     <h2 class="accordion-header" id="headingBanche"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBanche" aria-expanded="false" aria-controls="collapseBanche"> <i class="fas fa-university me-2"></i> Dettaglio per Banca (<span id="bancheReportDate">--</span>) </button> </h2>
                     <div id="collapseBanche" class="accordion-collapse collapse" aria-labelledby="headingBanche" data-bs-parent="#crDetailsAccordion">
                         <div class="accordion-body">
                             <h6>Dettaglio Accordato Operativo / Utilizzato (Ultimo Mese)</h6>
                              <div class="table-responsive">
                                  <table class="table table-sm table-striped table-hover small" id="bancheTable">
                                      <thead class="table-light">
                                          <tr>
                                              <th>Banca</th>
                                              <th class="text-end">Acc. Autoliq (€)</th>
                                              <th class="text-end">Acc. Scadenza (€)</th>
                                              <th class="text-end">Acc. Revoca (€)</th>
                                              <th class="text-end">Util. Autoliq (€)</th>
                                              <th class="text-end">Util. Scadenza (€)</th>
                                              <th class="text-end">Util. Revoca (€)</th>
                                          </tr>
                                      </thead>
                                      <tbody><tr><td colspan="7" class="text-muted">Caricamento...</td></tr></tbody>
                                  </table>
                              </div>
                              <!-- Nested Accordion for Historical Data -->
                              <div class="accordion accordion-flush small" id="historicalBankData">
                                  <div class="accordion-item">
                                      <h2 class="accordion-header" id="headingHistory"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory" aria-expanded="false" aria-controls="collapseHistory">Visualizza Dati Storici Dettagliati per Banca (Ultimi 12 Mesi)</button></h2>
                                      <div id="collapseHistory" class="accordion-collapse collapse" aria-labelledby="headingHistory" data-bs-parent="#historicalBankData">
                                          <div class="accordion-body p-0">
                                              <p class="text-muted ps-3">Tabella dettagliata dell'evoluzione mensile di accordato e utilizzato per singola banca.</p>
                                              <div class="table-responsive">
                                                  <table class="table table-sm table-bordered table-striped table-hover" style="font-size: 0.75rem;" id="bancheStoricoTable">
                                                      <thead class="table-light">
                                                          <tr>
                                                              <th>Periodo</th>
                                                              <th class="text-end">Acc. Autoliq</th><th class="text-end">Acc. Scadenza</th><th class="text-end">Acc. Revoca</th>
                                                              <th class="text-end">Util. Autoliq</th><th class="text-end">Util. Scadenza</th><th class="text-end">Util. Revoca</th>
                                                          </tr>
                                                      </thead>
                                                      <tbody><tr><td colspan="7" class="text-muted">Caricamento...</td></tr></tbody>
                                                  </table>
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              </div> <!-- Fine Nested Accordion -->
                         </div>
                     </div>
                 </div>

             </div> <!-- Fine Accordion Principale -->

        </div> <!-- /dashboard-container -->

        <!-- Footer Standard V2 -->
        <footer class="footer no-print"> <div class="container-fluid px-4"> <div class="row align-items-center"> <div class="col-md-6 text-center text-md-start mb-2 mb-md-0"> SCAN360 © <span id="currentYearFooterReport"></span> </div> <div class="col-md-6 text-center text-md-end"> Powered by <a href="http://www.kitzanos.com" target="_blank" class="text-white fw-bold">Kitzanos Lab</a> <img src="assets/img/logo_kitzanos.png" alt="Kitzanos Logo" class="ms-2" style="height: 20px; vertical-align: middle;"> </div> </div> </div> </footer>

    </div> <!-- /main-wrapper -->

    <!-- Script JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // ======================================
        // HELPER FUNCTIONS (Embedded)
        // ======================================
        function formatCurrency(value, decimals = 0) {
            if (value === null || value === undefined || isNaN(value)) return '--';
            return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(value);
        }
        function formatNumber(value, decimals = 0) {
             if (value === null || value === undefined || isNaN(value)) return '--';
             return new Intl.NumberFormat('it-IT', { style: 'decimal', minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(value);
         }
        function formatPercentage(value) {
             if (value === null || value === undefined || isNaN(value)) return '--%';
             return new Intl.NumberFormat('it-IT', { style: 'decimal', minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(value) + '%';
        }
         function formatTrend(value, unit = '') {
            if (value === null || value === undefined || value === "") return '--';
            return value + unit;
        }

        // Helper function to safely set text content
        function setText(elementId, text) {
            try {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = text ?? '--'; // Use '--' if text is null/undefined
                } else {
                    console.warn(`Element with ID '${elementId}' not found.`);
                }
            } catch (e) {
                console.error(`Error setting text for ID ${elementId}:`, e);
            }
        }

        // Helper function to safely set inner HTML
        function setHtml(elementId, html) {
             try {
                const element = document.getElementById(elementId);
                if (element) {
                    element.innerHTML = html ?? '<p class="text-muted">Dati non disponibili.</p>';
                } else {
                    console.warn(`Element with ID '${elementId}' not found.`);
                }
            } catch (e) {
                console.error(`Error setting HTML for ID ${elementId}:`, e);
            }
        }


        // Function to initialize chart
        function initChart(canvasId, type, data, options) {
             const canvas = document.getElementById(canvasId);
             if (!canvas) { console.error(`Canvas element with ID '${canvasId}' not found.`); return null; }
             const ctx = canvas.getContext('2d');
             const existingChart = Chart.getChart(canvasId);
             if (existingChart) { try { existingChart.destroy(); } catch(e) { console.warn(`Could not destroy previous chart instance for ${canvasId}: ${e}`);} }
             ctx.clearRect(0, 0, canvas.width, canvas.height);
             // Check for valid data structure AND non-empty data arrays
             if (!data || !data.labels || !data.labels.length || !data.datasets || data.datasets.length === 0 || !data.datasets.every(ds => ds.data && ds.data.length > 0 && ds.data.length === data.labels.length)) {
                  ctx.fillStyle = '#6c757d'; ctx.font = '14px "Titillium Web", sans-serif'; ctx.textAlign = 'center';
                  ctx.fillText('Dati non disponibili per questo grafico.', canvas.width / 2, canvas.height / 2);
                  console.warn(`Dati non validi o vuoti forniti a initChart per ${canvasId}`, data); return null;
              }
             try { return new Chart(ctx, { type: type, data: data, options: options }); }
             catch (error) {
                  console.error(`Errore durante la creazione del grafico ${canvasId}:`, error);
                  ctx.fillStyle = 'red'; ctx.font = '14px "Titillium Web", sans-serif'; ctx.textAlign = 'center';
                  const msg = error.message?.length > 100 ? error.message.substring(0, 97) + '...' : error.message;
                  ctx.fillText(`Errore grafico: ${msg || 'Sconosciuto'}`, canvas.width / 2, canvas.height / 2); return null;
             }
         }

        // ======================================
        // DATA LOADING AND PROCESSING (From JSON)
        // ======================================
        const jsonData = { /* Paste JSON content here */
          "intestatario": {
            "nome": "Alpha Srl",
            "codiceFiscale": "04748590948",
            "codiceCensito": "4694697539",
            "sede": "CATANZARO",
            "dataRiferimento": "Febbraio 2025",
            "dataEsecuzione": "08/04/2025"
          },
          "crScore": {
            "punteggio": 72,
            "fascia": "Monitoraggio",
            "classe": "bg-warning text-dark",
            "descrizione": "Il punteggio riflette una situazione con elementi da monitorare, in particolare per la presenza di crediti scaduti impagati"
          },
          "kpi": {
            "monteAffidamenti": { "valore": 242067, "trend": "Stabile ultimi 6m", "classe": "trend-neutral" },
            "monteUtilizzi": { "valore": 185782, "percentuale": 76.7, "trend": "Utilizzo: 76.7%", "classe": "trend-neutral" },
            "sconfiniInsoluti": { "valore": 300000, "trend": "Criticità Media", "classe": "trend-neutral text-warning" },
            "creditiScaduti": { "valore": "Presenti", "trend": "Segnale di Attenzione", "classe": "text-warning" },
            "sofferenze": { "valore": "Assenti", "trend": "Nessuna Segnalazione", "classe": "text-success" },
            "bancheSegnalanti": { "valore": 2, "trend": "Ultimi 6m: 2", "classe": "trend-neutral" },
            "garanzieRilasciate": { "valore": 109071, "trend": "Su proprie esposizioni", "classe": "trend-neutral" },
            "tipoGaranzie": { "valore": "Confidi e MCC", "trend": "Copertura: 58.7%", "classe": "trend-neutral" }
          },
          "anomalie": [
            { "titolo": "Crediti Scaduti Impagati", "descrizione": "Segnalazione di crediti autoliquidanti scaduti impagati per €300.000 rilevati a gennaio 2025.", "classe": "alert-warning", "livello": "Attenzione", "icona": "fas fa-hourglass-half" },
            { "titolo": "Utilizzo Variabile del Fido a Revoca", "descrizione": "Oscillazioni significative nell'utilizzo del fido a revoca nei mesi recenti.", "classe": "alert-warning", "livello": "Attenzione", "icona": "fas fa-tachometer-alt" }
          ],
          "charts": {
            "trendAccordiUtilizzi": {
              "labels": ["feb-24", "mar-24", "apr-24", "mag-24", "giu-24", "lug-24", "ago-24", "set-24", "ott-24", "nov-24", "dic-24", "gen-25", "feb-25"],
              "accordato": [292477, 288338, 284215, 280061, 275907, 271724, 267539, 263338, 259109, 254877, 250618, 246354, 242067],
              "utilizzato": [259856, 255555, 239076, 239855, 239407, 239422, 234657, 243526, 249086, 249196, 238007, 216892, 185782]
            },
            "distAffidamenti": { "labels": ["Autoliquidante", "Scadenza", "Revoca"], "valori": [41.3, 46.3, 12.4] },
            "trendSconfini": { "labels": ["set-24", "ott-24", "nov-24", "dic-24", "gen-25", "feb-25"], "valori": [0, 0, 0, 0, 300000, 0] },
            "trendGaranzie": { "labels": ["feb-24", "apr-24", "giu-24", "ago-24", "ott-24", "dic-24", "feb-25"], "valori": [193623, 187641, 181623, 175556, 169440, 83276, 109071] }
          },
          "dettaglioScoring": {
            "punteggio": 72, "fascia": "Monitoraggio", "descrizione": "Il punteggio riflette una situazione con alcuni elementi da monitorare ma senza criticità gravi.",
            "anomalie": [
              {"nome": "Crediti Passati a Perdita / Sofferenze", "stato": "Assente", "classe": "bg-success", "icona": "fas fa-times-circle text-success"},
              {"nome": "Insoluti / Sconfini", "stato": "Presente", "classe": "bg-warning text-dark", "icona": "fas fa-exclamation-triangle text-warning"},
              {"nome": "Tensione Finanziaria", "stato": "Presente", "classe": "bg-warning text-dark", "icona": "fas fa-tachometer-alt text-warning"},
              {"nome": "Errate Segnalazioni", "stato": "Assente", "classe": "bg-success", "icona": "fas fa-edit text-success"},
              {"nome": "Anomalie su Garanzie", "stato": "Assente", "classe": "bg-success", "icona": "fas fa-shield-alt text-success"},
              {"nome": "Crediti Scaduti >90/180 gg (Past Due)", "stato": "Presente", "classe": "bg-warning text-dark", "icona": "fas fa-calendar-times text-warning"},
              {"nome": "Insoluti Categorie Particolari", "stato": "Assente", "classe": "bg-success", "icona": "fas fa-random text-success"},
              {"nome": "Insoluti Anticipazioni / Concentrazione Rischio", "stato": "Presente", "classe": "bg-warning text-dark", "icona": "fas fa-chart-pie text-warning"},
              {"nome": "Posizioni Contestate", "stato": "Assente", "classe": "bg-success", "icona": "fas fa-gavel text-success"},
              {"nome": "Derivati Finanziari", "stato": "Assente", "classe": "bg-success", "icona": "fas fa-chart-line text-success"}
            ]
          },
          "dettaglioAffidamenti": {
            "tabella": [
              {"tipo": "Autoliquidante", "accordato": 100000, "utilizzato": 81232, "utilizzoPerc": 81.2, "trend": "Acc. Stabile / Util. Oscillante"},
              {"tipo": "Scadenza", "accordato": 112067, "utilizzato": 104550, "utilizzoPerc": 93.3, "trend": "Acc./Util. In Diminuzione"},
              {"tipo": "Revoca", "accordato": 30000, "utilizzato": 0, "utilizzoPerc": 0.0, "trend": "Util. Oscillante"},
              {"tipo": "Totale", "accordato": 242067, "utilizzato": 185782, "utilizzoPerc": 76.7, "trend": "Utilizzo Adeguato"}
            ],
            "utilizzoMedio": { "autoliquidante": 60.2, "scadenza": 94.8, "revoca": 73.4 },
            "descrizione": "L'utilizzo delle linee a scadenza è elevato e stabile, mentre le linee autoliquidanti mostrano oscillazioni significative. Le linee a revoca mostrano un utilizzo variabile, indicando una gestione flessibile della tesoreria."
          },
          "dettaglioSconfini": {
            "totale": 300000, "tipo": "Crediti Autoliquidanti Impagati", "evitabili": "Parzialmente", "periodo": "Gennaio 2025",
            "descrizione": "I crediti impagati sono concentrati su crediti autoliquidanti (probabilmente anticipo fatture) e potrebbero richiedere un'analisi dei debitori commerciali dell'azienda.",
            "banchePrincipali": [ { "banca": "BANCA DI CREDITO COOPERATIVO", "importoMedio": 300000, "tipologia": "Autoliquidanti - crediti scaduti", "periodo": "Gennaio 2025" } ]
          },
          "dettaglioGaranzie": {
            "totale": 109071,
            "garanti": [
              { "nome": "FIDICOOP SARDEGNA SOCIETA' COOPERATIVA", "valore": 57654, "percentuale": 52.9, "trend": "In diminuzione", "dettaglio": "Garanzia su crediti a scadenza" },
              { "nome": "FONDO DI GARANZIA L. 23.12.96 N. 662 CO MEDIOCREDITO CENTRALE", "valore": 51417, "percentuale": 47.1, "trend": "In diminuzione", "dettaglio": "Garanzie su linee autoliquidanti e a scadenza" }
            ],
            "descrizione": "Le garanzie sono principalmente fornite da Confidi regionali e dal Fondo Centrale di Garanzia, a copertura sia delle linee a scadenza sia di quelle autoliquidanti."
          },
          "dettaglioTesoreria": {
            "disponibilitaMediaRevoca": {
              "descrizione": "Nei mesi analizzati, la disponibilità media inutilizzata sulle linee a revoca è stata significativa in alcuni periodi, ma con oscillazioni importanti.",
              "banche": [ { "banca": "BANCA DI CREDITO COOPERATIVO", "disponibilitaMedia": 15000, "oscillazione": "Elevata" } ]
            },
            "equilibrioLinee": { "autoliquidante": 60.2, "scadenza": 94.8, "revoca": 73.4, "valutazione": "Corretto bilanciamento tra le diverse fonti di finanziamento, con un utilizzo più intenso delle linee a scadenza rispetto alle autoliquidanti e alle linee a revoca." },
            "rischiositaPortafoglio": { "descrizione": "La rischiosità degli effetti risulta generalmente stabile, con l'eccezione di gennaio 2025 dove si registrano crediti impagati. La 'riserva di liquidità' (disponibilità revoca) risulta sufficiente per la gestione ordinaria." }
          },
          "dettaglioBanche": {
            "tabella": [
              {"banca": "BANCA DI CREDITO COOPERATIVO", "accordatoAutoliq": 100000, "accordatoScadenza": 112067, "accordatoRevoca": 40000, "utilizzatoAutoliq": 81232, "utilizzatoScadenza": 104550, "utilizzatoRevoca": 32483},
              {"banca": "GIADA SEC. S.R.L.", "accordatoAutoliq": 0, "accordatoScadenza": 30007, "accordatoRevoca": 0, "utilizzatoAutoliq": 0, "utilizzatoScadenza": 30007, "utilizzatoRevoca": 0}
            ],
            "storicoMensile": [
              {"periodo": "feb-25", "accordatoAutoliq": 100000, "accordatoScadenza": 142074, "accordatoRevoca": 40000, "utilizzatoAutoliq": 81232, "utilizzatoScadenza": 134557, "utilizzatoRevoca": 32483},
              {"periodo": "gen-25", "accordatoAutoliq": 100000, "accordatoScadenza": 106354, "accordatoRevoca": 40000, "utilizzatoAutoliq": 0, "utilizzatoScadenza": 109429, "utilizzatoRevoca": 107463},
              {"periodo": "dic-24", "accordatoAutoliq": 100000, "accordatoScadenza": 110618, "accordatoRevoca": 40000, "utilizzatoAutoliq": 0, "utilizzatoScadenza": 110618, "utilizzatoRevoca": 127389},
              {"periodo": "nov-24", "accordatoAutoliq": 100000, "accordatoScadenza": 114877, "accordatoRevoca": 40000, "utilizzatoAutoliq": 100000, "utilizzatoScadenza": 114877, "utilizzatoRevoca": 34319},
              {"periodo": "ott-24", "accordatoAutoliq": 100000, "accordatoScadenza": 119109, "accordatoRevoca": 40000, "utilizzatoAutoliq": 100000, "utilizzatoScadenza": 119109, "utilizzatoRevoca": 29977},
              {"periodo": "set-24", "accordatoAutoliq": 100000, "accordatoScadenza": 123338, "accordatoRevoca": 40000, "utilizzatoAutoliq": 100000, "utilizzatoScadenza": 123338, "utilizzatoRevoca": 20188},
              {"periodo": "ago-24", "accordatoAutoliq": 100000, "accordatoScadenza": 127539, "accordatoRevoca": 40000, "utilizzatoAutoliq": 100000, "utilizzatoScadenza": 127539, "utilizzatoRevoca": 7118},
              {"periodo": "lug-24", "accordatoAutoliq": 100000, "accordatoScadenza": 131724, "accordatoRevoca": 40000, "utilizzatoAutoliq": 100000, "utilizzatoScadenza": 131724, "utilizzatoRevoca": 7698},
              {"periodo": "giu-24", "accordatoAutoliq": 100000, "accordatoScadenza": 135907, "accordatoRevoca": 40000, "utilizzatoAutoliq": 100000, "utilizzatoScadenza": 135907, "utilizzatoRevoca": 3500},
              {"periodo": "mag-24", "accordatoAutoliq": 100000, "accordatoScadenza": 140061, "accordatoRevoca": 40000, "utilizzatoAutoliq": 100000, "utilizzatoScadenza": 140061, "utilizzatoRevoca": -145},
              {"periodo": "apr-24", "accordatoAutoliq": 100000, "accordatoScadenza": 144215, "accordatoRevoca": 40000, "utilizzatoAutoliq": 100000, "utilizzatoScadenza": 144215, "utilizzatoRevoca": -5139},
              {"periodo": "mar-24", "accordatoAutoliq": 100000, "accordatoScadenza": 148338, "accordatoRevoca": 40000, "utilizzatoAutoliq": 100000, "utilizzatoScadenza": 148338, "utilizzatoRevoca": 7217},
              {"periodo": "feb-24", "accordatoAutoliq": 100000, "accordatoScadenza": 152477, "accordatoRevoca": 40000, "utilizzatoAutoliq": 100000, "utilizzatoScadenza": 152477, "utilizzatoRevoca": 7379}
            ]
          },
          "richiesteInformazioni": [
            {"data": "19/02/2025", "intermediario": "SARDA FACTORING S.P.A.", "periodo": "aprile 2024 - dicembre 2024", "nominativo": "Alpha Srl"}
          ],
          "sintesiEsecutiva": "L'analisi della Centrale Rischi di KITZANOS SOC. COOP. a febbraio 2025 evidenzia una situazione complessivamente sotto controllo con un punteggio CR stimato di 72/100 ('Monitoraggio'). L'accordato totale è di €242.067 con un utilizzo di €185.782 (76,7%). Da segnalare la presenza di crediti autoliquidanti scaduti impagati per €300.000 rilevati a gennaio 2025. Non risultano sofferenze, ma è consigliabile un monitoraggio dell'andamento, in particolare per l'oscillazione dell'utilizzo del fido a revoca. Le garanzie ricevute da FIDICOOP SARDEGNA e dal Fondo di Garanzia MCC coprono il 58,7% dell'esposizione totale."
        };


        // ======================================
        // CHART DATA CONFIGURATION (Using jsonData)
        // ======================================
        const crChartData = {
            trendAccordiUtilizzi: {
                labels: jsonData.charts?.trendAccordiUtilizzi?.labels ?? [],
                datasets: [
                    { label: 'Accordato Operativo (€)', data: jsonData.charts?.trendAccordiUtilizzi?.accordato ?? [],
                      borderColor: 'rgba(25, 25, 112, 1)', backgroundColor: 'rgba(25, 25, 112, 0.1)', type: 'line', fill: true, yAxisID: 'y' },
                    { label: 'Utilizzato (€)', data: jsonData.charts?.trendAccordiUtilizzi?.utilizzato ?? [],
                      borderColor: 'rgba(77, 140, 87, 1)', backgroundColor: 'rgba(77, 140, 87, 0.7)', type: 'bar', yAxisID: 'y' }
                ]
            },
            distAffidamenti: {
                labels: jsonData.charts?.distAffidamenti?.labels ?? [],
                datasets: [{
                    data: jsonData.charts?.distAffidamenti?.valori ?? [],
                    backgroundColor: ['#4a69bd', '#191970', '#FFC107'] // Autol., Scad., Revoca
                }]
            },
            trendSconfini: {
                labels: jsonData.charts?.trendSconfini?.labels ?? [],
                 datasets: [{
                     label: 'Sconfini/Impagati Segnalati (€)',
                     data: jsonData.charts?.trendSconfini?.valori ?? [],
                     borderColor: 'rgba(214, 34, 70, 1)',
                     backgroundColor: 'rgba(214, 34, 70, 0.7)',
                     fill: true,
                     type: 'bar'
                 }]
            },
            trendGaranzie: {
                labels: jsonData.charts?.trendGaranzie?.labels ?? [],
                datasets: [{
                    label: 'Valore Garanzie Ricevute (€)',
                    data: jsonData.charts?.trendGaranzie?.valori ?? [],
                    borderColor: 'rgba(77, 140, 87, 1)',
                    backgroundColor: 'rgba(77, 140, 87, 0.2)',
                    fill: true,
                    type: 'line'
                }]
            }
        };

        // ======================================
        // CHART OPTIONS (CR Report)
        // ======================================
        const commonChartOptionsCR = {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10, font: { size: 10 } } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || context.label || '';
                            if(label) label += ': ';
                            let value = context.parsed?.y ?? context.parsed?.r ?? context.raw; // Use optional chaining and nullish coalescing
                            if(value !== null && value !== undefined && !isNaN(value)) {
                                const isPercentage = context.dataset.label?.includes('(%)') ||
                                                     label.includes('%') ||
                                                     context.chart?.config?.type === 'pie' ||
                                                     context.chart?.config?.type === 'doughnut';
                                if (isPercentage) {
                                    label += formatPercentage(value);
                                } else {
                                    label += formatCurrency(value);
                                }
                            } else {
                                label += 'N/D';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: { grid: { display: false }, ticks:{ font: { size: 10 } } },
                y: { grid: { color: '#eee' }, ticks:{ font: { size: 10 }, callback: function(v) {return formatCurrency(v/1000,'0')+'K'} } }
            },
            animation: { duration: 400 }
        };
        const pieChartOptionsCR = { ...commonChartOptionsCR, scales: { x: { display: false }, y: { display: false } } };
        pieChartOptionsCR.plugins.tooltip.callbacks.label = function(context) {
             let label = context.label || '';
             let value = context.raw || 0;
             return `${label}: ${formatPercentage(value)}`;
         };

        const lineChartOptionsCR = { ...commonChartOptionsCR };
        const barLineComboOptionsCR = { ...commonChartOptionsCR, scales: { ...commonChartOptionsCR.scales, y: { ...commonChartOptionsCR.scales.y, beginAtZero: true } } };
        const barChartOptionsCR = { ...commonChartOptionsCR, scales: { ...commonChartOptionsCR.scales, y: { ...commonChartOptionsCR.scales.y, beginAtZero: true } } };


        // ======================================
        // DOM POPULATION & OTHER SCRIPTS
        // ======================================
         document.addEventListener('DOMContentLoaded', function() {
            console.log("Populating CR Report from JSON data...");
            try {
                // --- Basic Info ---
                const companyName = jsonData?.intestatario?.nome ?? 'N/D';
                const reportDate = jsonData?.intestatario?.dataRiferimento ?? 'N/D';
                setText('sidebarCompanyName', companyName);
                setText('headerCompanyName', companyName);
                setText('headerReportDate', reportDate);
                setText('printCompanyName', companyName);
                setText('printReportDate', reportDate);
                setText('headerUserName', companyName);
                setText('summaryReportDate', reportDate);
                setText('kpiReportDate', reportDate);
                setText('alertsReportDate', reportDate);
                setText('scoringReportDate1', reportDate);
                setText('affidamentiReportDate', reportDate);
                setText('sconfiniReportDate', reportDate);
                setText('garanzieReportDate', reportDate);
                setText('bancheReportDate', reportDate);

                // --- CR Score & Summary ---
                const crScoreData = jsonData?.crScore;
                const crScoreCircleEl = document.getElementById('crScoreCircle');
                const crScoreCircleValueEl = document.getElementById('crScoreCircleValue');
                const crScoreCategoryTextEl = document.getElementById('crScoreCategoryText');
                const crScoreCategoryBadgeEl = document.getElementById('crScoreCategoryBadge');

                if (crScoreData) {
                    setText('summaryText1', `L'analisi della Centrale Rischi di ${companyName} a ${reportDate} evidenzia un punteggio CR di ${formatNumber(crScoreData.punteggio, 0)}/100 ('${crScoreData.fascia}'). L'accordato totale è di ${formatCurrency(jsonData.kpi?.monteAffidamenti?.valore ?? 0)} con un utilizzo di ${formatCurrency(jsonData.kpi?.monteUtilizzi?.valore ?? 0)} (${formatPercentage(jsonData.kpi?.monteUtilizzi?.percentuale ?? 0)}).`);
                    setText('summaryText2', crScoreData.descrizione);

                    let riskClass = 'risk-high'; // Default to high risk
                    let categoryText = 'Pericolo';
                    let categoryBadgeText = 'P';
                    let categoryTextColor = 'text-danger';
                    let badgeClass = 'bg-danger';

                    if (crScoreData.punteggio >= 80) { // Ottimizzabile/Corretto
                        riskClass = 'risk-low';
                        categoryText = 'Ottimizzabile'; // Or 'Corretto' if 100
                        categoryBadgeText = 'O'; // Or 'C'
                        categoryTextColor = 'text-success';
                        badgeClass = 'bg-success';
                    } else if (crScoreData.punteggio >= 60) { // Monitoraggio/Vulnerabile
                        riskClass = 'risk-medium';
                        categoryText = crScoreData.fascia; // Use fascia from JSON ('Monitoraggio')
                        categoryBadgeText = 'M'; // Or 'V'
                        categoryTextColor = 'text-warning';
                        badgeClass = crScoreData.classe; // Use class from JSON ('bg-warning text-dark')
                    } else { // Pericolo
                         // Defaults already set for risk-high
                         categoryText = crScoreData.fascia; // Use fascia from JSON ('Pericolo') if available
                         badgeClass = crScoreData.classe; // Use class from JSON ('bg-danger')
                    }

                    // Apply styles to the circle
                    if(crScoreCircleEl) {
                        crScoreCircleEl.classList.remove('risk-low', 'risk-medium', 'risk-high');
                        crScoreCircleEl.classList.add(riskClass);
                    }
                    setText(crScoreCircleValueEl?.id, formatNumber(crScoreData.punteggio, 0)); // Use helper

                    // Apply styles to the text below
                     if(crScoreCategoryTextEl && crScoreCategoryBadgeEl) {
                         crScoreCategoryTextEl.classList.remove('text-success', 'text-warning', 'text-danger');
                         crScoreCategoryTextEl.classList.add(categoryTextColor);
                         crScoreCategoryTextEl.textContent = `${categoryText} `; // Set text then append badge
                         crScoreCategoryBadgeEl.textContent = categoryBadgeText;
                         crScoreCategoryBadgeEl.className = `status-badge ${badgeClass}`;
                         crScoreCategoryTextEl.appendChild(crScoreCategoryBadgeEl);
                     }


                     // Update Header Badge
                     const crHeaderBadgeEl = document.getElementById('cr-header-badge');
                     if (crHeaderBadgeEl && crScoreData.punteggio !== null) {
                        crHeaderBadgeEl.className = `badge ${crScoreData.classe ?? 'bg-secondary'} me-3`;
                        crHeaderBadgeEl.textContent = `Score CR: ${crScoreData.punteggio}/100`;
                     } else if (crHeaderBadgeEl) {
                        crHeaderBadgeEl.textContent = 'Score CR: N/D';
                        crHeaderBadgeEl.className = 'badge bg-secondary me-3';
                     }

                } else {
                    setText('summaryText1', 'Dati CR Score non disponibili.');
                    setText(crScoreCircleValueEl?.id, '--');
                    setText(crScoreCategoryTextEl?.id, '--');
                     if(crScoreCategoryBadgeEl) crScoreCategoryBadgeEl.textContent = '--';
                     const crHeaderBadgeEl = document.getElementById('cr-header-badge');
                     if (crHeaderBadgeEl) crHeaderBadgeEl.textContent = 'Score CR: N/D';
                }


                 // --- KPIs ---
                const kpiContainer = document.getElementById('kpi-cards-container');
                kpiContainer.innerHTML = ''; // Clear placeholder/skeletons
                const kpiMap = [
                    { key: 'monteAffidamenti', title: 'Monte Affidamenti', icon: 'fa-file-invoice-dollar', format: (v) => formatCurrency(v, 0), bg: 'bg-icon-primary'},
                    { key: 'monteUtilizzi', title: 'Monte Utilizzi', icon: 'fa-hand-holding-usd', format: (v) => formatCurrency(v, 0), bg: 'bg-icon-info' },
                    { key: 'sconfiniInsoluti', title: 'Sconfini / Impagati (Gen 25)', icon: 'fa-exclamation-triangle', format: (v) => formatCurrency(v, 0), bg: 'bg-icon-warning' },
                    { key: 'creditiScaduti', title: 'Crediti Scaduti >90gg', icon: 'fa-hourglass-half', format: (v) => v, bg: 'bg-icon-warning' },
                    { key: 'sofferenze', title: 'Sofferenze', icon: 'fa-user-shield', format: (v) => v, bg: 'bg-icon-success' },
                    { key: 'bancheSegnalanti', title: 'Banche Segnalanti', icon: 'fa-landmark', format: (v) => formatNumber(v, 0), bg: 'bg-icon-info' },
                    { key: 'garanzieRilasciate', title: 'Garanzie Ricevute', icon: 'fa-shield-alt', format: (v) => formatCurrency(v, 0), bg: 'bg-icon-primary' },
                    { key: 'tipoGaranzie', title: 'Tipo Garanzie Principali', icon: 'fa-tags', format: (v) => v, bg: 'bg-icon-secondary' }
                ];
                if (jsonData.kpi) {
                    kpiMap.forEach(kpi => {
                        const kpiData = jsonData.kpi[kpi.key];
                        const value = kpiData?.valore;
                        const trendText = kpiData?.trend ?? '--';
                        const trendClass = kpiData?.classe ?? 'trend-neutral';
                        const valueClass = value === 'Presenti' ? 'text-warning' : (value === 'Assenti' ? 'text-success' : '');
                        const formattedValue = (value !== undefined && value !== null) ? kpi.format(value) : '--';

                        const cardHtml = `
                            <div class="col-lg-3 col-md-6">
                                <div class="kpi-card-v4">
                                    <span class="icon-circle ${kpi.bg}"><i class="fas ${kpi.icon}"></i></span>
                                    <div class="kpi-content">
                                        <div class="kpi-title">${kpi.title}</div>
                                        <div class="kpi-value ${valueClass}">${formattedValue}</div>
                                        <div class="kpi-trend ${trendClass}">${trendText}</div>
                                    </div>
                                </div>
                            </div>`;
                        kpiContainer.innerHTML += cardHtml;
                    });
                } else {
                    setHtml('kpi-cards-container', '<div class="col-12"><p class="text-muted">Dati KPI non disponibili.</p></div>');
                }

                // --- Alerts ---
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = '';
                if (jsonData.anomalie && jsonData.anomalie.length > 0) {
                    jsonData.anomalie.forEach(anomaly => {
                        const badgeBg = anomaly.classe?.includes('warning') ? 'bg-warning text-dark' : anomaly.classe?.includes('danger') ? 'bg-danger' : 'bg-info text-dark';
                        const alertHtml = `
                            <div class="col-lg-6 mb-4">
                                <div class="alert-card ${anomaly.classe || 'alert-warning'}">
                                    <i class="${anomaly.icona || 'fas fa-exclamation-triangle'} alert-icon"></i>
                                    <div>
                                        <h5>${anomaly.titolo || 'Anomalia'} <span class="badge ${badgeBg} ms-2">${anomaly.livello || 'Attenzione'}</span></h5>
                                        <p>${anomaly.descrizione || 'N/D'}</p>
                                    </div>
                                </div>
                            </div>`;
                        alertsContainer.innerHTML += alertHtml;
                    });
                } else {
                    setHtml('alerts-container', '<div class="col-12"><div class="alert alert-success">Nessuna anomalia significativa rilevata.</div></div>');
                }

                 // --- Accordion Details (with checks for data existence) ---
                if (jsonData.dettaglioScoring) {
                     setText('scoringValue1', formatNumber(jsonData.dettaglioScoring.punteggio, 0));
                     setText('scoringFascia1', jsonData.dettaglioScoring.fascia);
                     setText('scoringDesc1', jsonData.dettaglioScoring.descrizione);
                     const anomList = document.getElementById('anomalie-list-details');
                     if(anomList){
                        anomList.innerHTML = '';
                        jsonData.dettaglioScoring.anomalie?.forEach(a => {
                            anomList.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><i class="${a.icona ?? 'fas fa-question-circle'} me-2"></i> ${a.nome ?? 'N/D'} <span class="badge ${a.classe ?? 'bg-secondary'}">${a.stato ?? 'N/D'}</span></li>`;
                        });
                        if(!jsonData.dettaglioScoring.anomalie || jsonData.dettaglioScoring.anomalie.length === 0){
                             anomList.innerHTML = '<li class="list-group-item text-muted">Nessuna anomalia specifica nel dettaglio.</li>';
                        }
                     }
                 } else {
                     // Handle missing detail sections gracefully
                     setHtml('collapseScoring .accordion-body', '<p class="text-muted">Dettaglio scoring non disponibile.</p>');
                 }

                if (jsonData.dettaglioAffidamenti) {
                    const affTableBody = document.querySelector('#affidamentiTable tbody');
                    if(affTableBody){
                        affTableBody.innerHTML = ''; // Clear placeholder
                        jsonData.dettaglioAffidamenti.tabella?.forEach(row => {
                            affTableBody.innerHTML += `<tr><td>${row.tipo ?? 'N/D'}</td><td class="text-end">${formatCurrency(row.accordato)}</td><td class="text-end">${formatCurrency(row.utilizzato)}</td><td class="text-end">${formatPercentage(row.utilizzoPerc)}</td><td>${row.trend ?? '--'}</td></tr>`;
                        });
                         if (!jsonData.dettaglioAffidamenti.tabella || jsonData.dettaglioAffidamenti.tabella.length === 0) {
                             affTableBody.innerHTML = '<tr><td colspan="5" class="text-muted">Nessun dato disponibile per la tabella affidamenti.</td></tr>';
                         }
                    }
                    setText('utilizzoMedioAutoliq', `Autoliquidante: ${formatPercentage(jsonData.dettaglioAffidamenti.utilizzoMedio?.autoliquidante)}`);
                    setText('utilizzoMedioScadenza', `Scadenza: ${formatPercentage(jsonData.dettaglioAffidamenti.utilizzoMedio?.scadenza)}`);
                    setText('utilizzoMedioRevoca', `Revoca: ${formatPercentage(jsonData.dettaglioAffidamenti.utilizzoMedio?.revoca)}`);
                    setText('affidamentiDesc', jsonData.dettaglioAffidamenti.descrizione);
                 } else {
                     setHtml('collapseAffidamenti .accordion-body', '<p class="text-muted">Dettaglio affidamenti non disponibile.</p>');
                 }

                 if (jsonData.dettaglioSconfini) {
                     setText('sconfiniTotali', formatCurrency(jsonData.dettaglioSconfini.totale));
                     setText('sconfiniTipo', jsonData.dettaglioSconfini.tipo);
                     setText('sconfiniEvitabili', jsonData.dettaglioSconfini.evitabili);
                     setText('sconfiniPeriodo', jsonData.dettaglioSconfini.periodo);
                     setText('sconfiniDesc', jsonData.dettaglioSconfini.descrizione);
                     const sconfBancheList = document.getElementById('sconfiniBancheList');
                     if(sconfBancheList){
                        sconfBancheList.innerHTML = '';
                         jsonData.dettaglioSconfini.banchePrincipali?.forEach(b => {
                            sconfBancheList.innerHTML += `<li>${b.banca ?? 'N/D'}: ${b.tipologia ?? 'N/D'} (${b.periodo ?? 'N/D'}) - Importo: ${formatCurrency(b.importoMedio)}</li>`; // Changed label
                         });
                         if (!jsonData.dettaglioSconfini.banchePrincipali || jsonData.dettaglioSconfini.banchePrincipali.length === 0) {
                            sconfBancheList.innerHTML = '<li class="text-muted">Nessuna banca con segnalazioni principali.</li>';
                         }
                     }
                 } else {
                      setHtml('collapseSconfini .accordion-body', '<p class="text-muted">Dettaglio sconfini non disponibile.</p>');
                 }

                if (jsonData.dettaglioGaranzie) {
                    setText('garanzieTotali', formatCurrency(jsonData.dettaglioGaranzie.totale));
                    const garList = document.getElementById('garanzieList');
                    if(garList){
                        garList.innerHTML = '';
                        jsonData.dettaglioGaranzie.garanti?.forEach(g => {
                            garList.innerHTML += `<li>${g.nome ?? 'N/D'}: ${formatCurrency(g.valore)} (${formatPercentage(g.percentuale)}) - Trend: ${g.trend ?? '--'} (${g.dettaglio ?? 'N/D'})</li>`;
                        });
                        if (!jsonData.dettaglioGaranzie.garanti || jsonData.dettaglioGaranzie.garanti.length === 0) {
                            garList.innerHTML = '<li class="text-muted">Nessun garante principale specificato.</li>';
                        }
                    }
                    setText('garanzieDesc', jsonData.dettaglioGaranzie.descrizione);
                 } else {
                      setHtml('collapseGaranzie .accordion-body', '<p class="text-muted">Dettaglio garanzie non disponibile.</p>');
                 }


                 if (jsonData.dettaglioTesoreria) {
                     setText('tesoreriaDispDesc', jsonData.dettaglioTesoreria.disponibilitaMediaRevoca?.descrizione);
                     const tesDispBanche = document.getElementById('tesoreriaDispBanche');
                     if(tesDispBanche){
                        tesDispBanche.innerHTML = '';
                        jsonData.dettaglioTesoreria.disponibilitaMediaRevoca?.banche?.forEach(b => {
                             tesDispBanche.innerHTML += `<li>${b.banca ?? 'N/D'}: ${formatCurrency(b.disponibilitaMedia)} (Oscillazione: ${b.oscillazione ?? '--'})</li>`;
                         });
                         if (!jsonData.dettaglioTesoreria.disponibilitaMediaRevoca?.banche || jsonData.dettaglioTesoreria.disponibilitaMediaRevoca.banche.length === 0) {
                              tesDispBanche.innerHTML = '<li class="text-muted">Nessun dettaglio disponibilità per banca.</li>';
                         }
                     }
                     const tesEqList = document.getElementById('tesoreriaEqList');
                     if(tesEqList){
                        tesEqList.innerHTML = `<li>Autoliquidante: ${formatPercentage(jsonData.dettaglioTesoreria.equilibrioLinee?.autoliquidante)}</li><li>Scadenza: ${formatPercentage(jsonData.dettaglioTesoreria.equilibrioLinee?.scadenza)}</li><li>Revoca: ${formatPercentage(jsonData.dettaglioTesoreria.equilibrioLinee?.revoca)}</li>`;
                     }
                     setText('tesoreriaEqValutazione', jsonData.dettaglioTesoreria.equilibrioLinee?.valutazione);
                     setText('tesoreriaRischioDesc', jsonData.dettaglioTesoreria.rischiositaPortafoglio?.descrizione);
                 } else {
                     setHtml('collapseTesoreria .accordion-body', '<p class="text-muted">Dettaglio tesoreria non disponibile.</p>');
                 }


                 if (jsonData.dettaglioBanche) {
                    const bancheTableBody = document.querySelector('#bancheTable tbody');
                    if(bancheTableBody){
                        bancheTableBody.innerHTML = '';
                        jsonData.dettaglioBanche.tabella?.forEach(b => {
                            bancheTableBody.innerHTML += `<tr><td>${b.banca ?? 'N/D'}</td><td class="text-end">${formatCurrency(b.accordatoAutoliq)}</td><td class="text-end">${formatCurrency(b.accordatoScadenza)}</td><td class="text-end">${formatCurrency(b.accordatoRevoca)}</td><td class="text-end">${formatCurrency(b.utilizzatoAutoliq)}</td><td class="text-end">${formatCurrency(b.utilizzatoScadenza)}</td><td class="text-end">${formatCurrency(b.utilizzatoRevoca)}</td></tr>`;
                        });
                         if (!jsonData.dettaglioBanche.tabella || jsonData.dettaglioBanche.tabella.length === 0) {
                              bancheTableBody.innerHTML = '<tr><td colspan="7" class="text-muted">Nessun dettaglio disponibile per banca.</td></tr>';
                         }
                    }
                    const bancheStoricoTableBody = document.querySelector('#bancheStoricoTable tbody');
                    if(bancheStoricoTableBody){
                        bancheStoricoTableBody.innerHTML = '';
                        jsonData.dettaglioBanche.storicoMensile?.forEach(h => {
                            bancheStoricoTableBody.innerHTML += `<tr><td>${h.periodo ?? '--'}</td><td class="text-end">${formatCurrency(h.accordatoAutoliq)}</td><td class="text-end">${formatCurrency(h.accordatoScadenza)}</td><td class="text-end">${formatCurrency(h.accordatoRevoca)}</td><td class="text-end">${formatCurrency(h.utilizzatoAutoliq)}</td><td class="text-end">${formatCurrency(h.utilizzatoScadenza)}</td><td class="text-end">${formatCurrency(h.utilizzatoRevoca)}</td></tr>`;
                        });
                         if (!jsonData.dettaglioBanche.storicoMensile || jsonData.dettaglioBanche.storicoMensile.length === 0) {
                              bancheStoricoTableBody.innerHTML = '<tr><td colspan="7" class="text-muted">Nessun dato storico disponibile per banca.</td></tr>';
                         }
                    }
                } else {
                     setHtml('collapseBanche .accordion-body', '<p class="text-muted">Dettaglio banche non disponibile.</p>');
                }

                // Initialize Charts with new data
                console.log("Initializing charts...");
                initChart('trendAccordiUtilizziChart', 'bar', crChartData.trendAccordiUtilizzi, barLineComboOptionsCR);
                initChart('distAffidamentiChart', 'pie', crChartData.distAffidamenti, pieChartOptionsCR);
                initChart('trendSconfiniChart', 'bar', crChartData.trendSconfini, barChartOptionsCR);
                initChart('trendGaranzieChart', 'line', crChartData.trendGaranzie, lineChartOptionsCR);
                console.log("Charts initialization attempt complete.");

                // Update Year
                setText('currentYearSidebar', new Date().getFullYear());
                setText('currentYearFooterReport', new Date().getFullYear());

            } catch (error) {
                console.error("Errore durante il popolamento della pagina:", error);
                const container = document.querySelector('.dashboard-container');
                if (container) {
                    container.innerHTML = `<div class="alert alert-danger">Si è verificato un errore imprevisto durante il caricamento dei dati. Controllare la console per dettagli. (${error.message})</div>`;
                }
            }

             // Ensure logout function is defined
             if (typeof logout !== 'function') { window.logout = function() { console.log("Logout placeholder"); } }
             // Ensure print function is defined
             if (typeof printDocument !== 'function') { window.printDocument = function() { window.print(); } }

             console.log("Page population and script execution finished.");
         });
</body>
</html>
